# 停止与确认发送功能说明

## 功能概述

停止与确认发送功能已完整实现，包含以下特性：

### C. 停止与确认发送 (Action: stop)

#### 1. 触发逻辑

##### 方式一：NFC 停止标签
- **触发**：录音时触碰"停止标签"（`heartecho://action/stop`）
- **条件**：仅在录音状态（`AppState.RECORDING`）时有效
- **流程**：
  1. 检测到停止标签
  2. 立即停止录音
  3. 触发震动反馈
  4. 播放确认引导语音
  5. 进入确认界面

##### 方式二：30 秒倒计时结束
- **触发**：录音自动达到 30 秒上限
- **流程**：
  1. AudioService 自动停止录音
  2. 触发震动反馈
  3. 播放确认引导语音
  4. 进入确认界面

#### 2. UI 确认界面

##### 屏幕布局
- **上半部**：红色取消按钮
  - 颜色：#F44336
  - 图标：✕（120sp）
  - 文字：「取消」（36sp）
  - 占据屏幕上半部分

- **下半部**：绿色发送按钮
  - 颜色：#4CAF50
  - 图标：✓（120sp）
  - 文字：「发送」（36sp）
  - 占据屏幕下半部分

##### 交互特性
- **全屏按钮**：无需精确点击
- **高对比度**：红绿分明，易于识别
- **大字体**：适合老年人使用

#### 3. 引导语音和震动提示

##### 震动反馈
- **触发时机**：进入确认界面时
- **震动时长**：500ms
- **实现方式**：
  - Android 8.0+：`VibrationEffect.createOneShot()`
  - 旧版本：`Vibrator.vibrate()`

##### 引导语音
- **文件**：`res/raw/confirm_send.mp3`
- **内容**：「录好了，按上面红色不要了，按下面绿色发给孙子」
- **播放时机**：震动后立即播放
- **播放完成**：自动进入确认界面（显示按钮）

#### 4. 用户操作

##### 取消操作（上半部红色按钮）
- **功能**：删除录音文件
- **流程**：
  1. 点击取消按钮
  2. 删除录音文件
  3. 显示提示：「已取消录音」
  4. 返回空闲状态

##### 发送操作（下半部绿色按钮）
- **功能**：保存录音到数据库
- **流程**：
  1. 点击发送按钮
  2. 保存到 Room 数据库
  3. 显示提示：「录音已保存 (ID: xxx)」
  4. 返回空闲状态

## 添加引导语音文件

### 步骤：
1. 录制或生成语音文件：「录好了，按上面红色不要了，按下面绿色发给孙子」
2. 转换为 MP3 格式
3. 将文件命名为 `confirm_send.mp3`（必须小写）
4. 放置在 `app/src/main/res/raw/` 目录下
5. 重新构建项目

### 注意事项：
- 文件名必须全部小写，只能包含 a-z、0-9 和下划线
- 如果没有此文件，应用会跳过引导语音直接显示确认界面
- 建议时长：5-8 秒（需要说明清楚操作方式）

## NFC 标签配置

### 停止标签
```
heartecho://action/stop
```

### 使用场景
- 用户想提前结束录音（不等 30 秒）
- 录音内容已完成，无需继续
- 误触录音标签后快速停止

## 技术实现

### 统一确认流程
```kotlin
private fun triggerConfirmation(filePath: String) {
    // 1. 震动反馈
    triggerVibration()

    // 2. 播放引导语音
    val guideResourceId = resources.getIdentifier("confirm_send", "raw", packageName)
    if (guideResourceId != 0) {
        audioPlayerService.playGuideAudio(guideResourceId) {
            // 3. 进入确认状态
            viewModel.setConfirmingState(filePath)
        }
    } else {
        viewModel.setConfirmingState(filePath)
    }
}
```

### 状态检查
- 停止标签仅在 `AppState.RECORDING` 时生效
- 防止在其他状态误触发

### 录音状态监听
- 监听 `audioService.recordingState`
- 检测 `isRecording = false` 且 `filePath != null`
- 确保当前状态为 `RECORDING`（避免重复触发）

## 已实现的功能

✅ NFC 停止标签触发
✅ 30 秒倒计时自动停止
✅ 震动反馈（500ms）
✅ 引导语音播放
✅ 确认界面（上红下绿）
✅ 取消操作（删除文件）
✅ 发送操作（保存数据库）
✅ 状态管理和流程控制

## 完整流程示例

### 场景一：NFC 停止
1. 用户触碰录制标签 → 开始录音
2. 录制 10 秒后，用户触碰停止标签
3. 手机震动 500ms
4. 播放：「录好了，按上面红色不要了，按下面绿色发给孙子」
5. 显示确认界面
6. 用户点击绿色按钮 → 保存成功

### 场景二：30 秒自动停止
1. 用户触碰录制标签 → 开始录音
2. 背景色：绿 → 黄 → 红（闪烁）
3. 30 秒倒计时结束，自动停止
4. 手机震动 500ms
5. 播放：「录好了，按上面红色不要了，按下面绿色发给孙子」
6. 显示确认界面
7. 用户点击红色按钮 → 取消录音

## 三个引导语音文件总结

| 文件名 | 内容 | 触发时机 |
|--------|------|---------|
| `start_record.mp3` | 「正在录音，请说话」 | 开始录音时 |
| `confirm_send.mp3` | 「录好了，按上面红色不要了，按下面绿色发给孙子」 | 进入确认界面时 |
| `play_start.mp3` | 「奶奶，正在为您播报最新的留言」 | 开始播放时 |

## 用户体验设计

### 老年人友好设计
1. **大按钮**：全屏上下分割，无需精确点击
2. **高对比度**：红绿分明，色盲友好
3. **震动反馈**：触觉提示，增强感知
4. **语音引导**：详细说明操作方式
5. **简单操作**：只需按上或按下

### 防误操作
- 停止标签仅在录音时有效
- 确认界面必须明确选择（取消或发送）
- 取消操作会删除文件，避免垃圾数据
