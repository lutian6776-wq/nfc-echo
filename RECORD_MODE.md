# 录制模式实现说明

## 功能概述

录制模式已完整实现，包含以下特性：

### B. 录制模式 (Action: record)

#### 1. 触发逻辑
- **NFC 触发**：触碰"录制标签"（`heartecho://action/record`）
- **震动反馈**：触发时手机震动 500ms
- **引导语音**：播放「正在录音，请说话」
- **3秒倒计时**：全屏显示红→蓝→绿倒计时，避免震动声被录制
- **30 秒录音**：倒计时结束后自动录制 30 秒

#### 2. UI 表现

##### 倒计时界面（3秒）
- **第3秒**：红色背景 (#F44336)
- **第2秒**：蓝色背景 (#2196F3)
- **第1秒**：绿色背景 (#4CAF50)
- **大字体倒计时**：180sp 超大数字
- **提示文字**：「准备说话」
- **目的**：
  - 给用户准备时间
  - 避免震动声被麦克风录制
  - 清晰的视觉提示

##### 录音界面 - 动态背景色
- **30s-16s**：绿色 (#4CAF50)
- **15s-6s**：黄色 (#FFC107)
- **5s-0s**：红色 (#F44336) + **剧烈闪烁效果**
  - 闪烁频率：300ms 切换一次
  - 透明度在 30% 和 100% 之间切换
  - 平滑过渡动画

##### 声音电平条
- **位置**：屏幕右侧
- **宽度**：80dp
- **高对比度设计**：
  - 背景：黑色半透明 (alpha 0.3)
  - 填充：根据音量变色
    - 低音量 (0-50%)：绿色
    - 中音量 (50-80%)：黄色
    - 高音量 (80-100%)：红色
- **实时跳动**：随 `maxAmplitude` 实时更新（100ms 刷新）
- **数值显示**：顶部显示归一化振幅值 (0-100)

#### 3. 引导语音
- **触发时播放**：`res/raw/start_record.mp3`
- **内容**：「正在录音，请说话」
- **流程**：
  1. NFC 触发
  2. 震动反馈
  3. 播放引导语音
  4. 显示3秒倒计时（红→蓝→绿）
  5. 倒计时结束后开始录音

#### 4. 录音完成
- 30 秒后自动停止
- 进入确认界面（上半部取消 / 下半部发送）

## 添加引导语音文件

### 步骤：
1. 录制或生成语音文件：「正在录音，请说话」
2. 转换为 MP3 格式
3. 将文件命名为 `start_record.mp3`（必须小写）
4. 放置在 `app/src/main/res/raw/` 目录下
5. 重新构建项目

### 注意事项：
- 文件名必须全部小写，只能包含 a-z、0-9 和下划线
- 如果没有此文件，应用会跳过引导语音直接开始录音
- 建议时长：2-3 秒

## 权限要求

已添加的权限：
```xml
<!-- 录音权限 -->
<uses-permission android:name="android.permission.RECORD_AUDIO" />

<!-- 震动权限 -->
<uses-permission android:name="android.permission.VIBRATE" />
```

## 技术实现

### 震动反馈
- Android 8.0+：使用 `VibrationEffect.createOneShot()`
- 旧版本：使用 `Vibrator.vibrate()`
- 震动时长：500ms

### 闪烁效果
- 使用 `animateFloatAsState` 实现透明度动画
- 基于系统时间判断闪烁状态
- 仅在剩余时间 ≤ 5 秒时触发

### 倒计时实现
- 使用 `LaunchedEffect` 实现协程倒计时
- 每秒更新一次状态
- 倒计时结束后自动触发录音开始
- 颜色根据倒计时数字动态切换

### 音量电平条
- 实时获取 `MediaRecorder.getMaxAmplitude()`
- 归一化到 0-100 范围
- 使用 `fillMaxHeight()` 动态调整高度
- 平滑动画过渡（100ms）

## 已实现的功能

✅ NFC 触发录音
✅ 震动反馈（500ms）
✅ 引导语音播放
✅ 3秒倒计时（红→蓝→绿）
✅ 30 秒录音倒计时
✅ 动态背景色（绿→黄→红）
✅ 红色背景剧烈闪烁（< 5s）
✅ 侧边高对比度电平条
✅ 实时振幅显示
✅ 自动停止录音
✅ 确认界面

## 测试流程

1. **创建 NFC 标签**：写入 `heartecho://action/record`
2. **触碰标签**：
   - 手机震动
   - 播放引导语音「正在录音，请说话」
3. **倒计时阶段**（3秒）：
   - 第3秒：红色背景
   - 第2秒：蓝色背景
   - 第1秒：绿色背景
   - 显示「准备说话」提示
4. **开始录音**：
   - 背景色从绿色开始
   - 侧边电平条实时跳动
5. **15 秒时**：背景变为黄色
6. **5 秒时**：背景变为红色并开始闪烁
7. **30 秒后**：自动停止，进入确认界面

## 与播放模式的区别

| 功能 | 录制模式 | 播放模式 |
|------|---------|---------|
| 引导语音 | start_record.mp3 | play_start.mp3 |
| 震动反馈 | ✅ 有 | ❌ 无 |
| 背景闪烁 | ✅ 有（< 5s） | ❌ 无 |
| 侧边电平条 | ✅ 有 | ❌ 无 |
| 进度条 | ❌ 无 | ✅ 有 |
