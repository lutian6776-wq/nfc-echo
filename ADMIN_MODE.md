# 管理员模式功能说明

## 功能概述

管理员模式是 HeartEcho 的高级功能，用于 NFC 标签写入和调试测试。

## 4. 管理员模式 (Admin Mode)

### 入口设计

#### 隐形长按区域
- **位置**：首页左上角
- **尺寸**：80dp × 80dp
- **视觉标识**：
  - 轻微白色半透明背景 (alpha 0.05)
  - 圆角矩形 (16dp)
  - 齿轮图标 ⚙ (半透明)
- **激活方式**：长按 5 秒

#### 长按反馈
- **环状进度圈**：
  - 实时显示长按进度
  - 5 秒线性动画
  - 白色进度条 (alpha 0.8)
  - 半透明轨道 (alpha 0.2)
- **图标变化**：
  - 未按下：半透明 (alpha 0.3)
  - 长按中：高亮 (alpha 0.8)

### 功能模块

#### A. NFC 写入器

##### 功能说明
负责将 AAR (包名) 和 Action URI 写入空白 NDEF 标签。

##### 支持的标签类型
1. **播放标签**
   - URI: `heartecho://action/play`
   - 颜色：蓝色 (#2196F3)
   - 功能：触发播放最新录音

2. **录制标签**
   - URI: `heartecho://action/record`
   - 颜色：绿色 (#4CAF50)
   - 功能：触发录音

3. **停止标签**
   - URI: `heartecho://action/stop`
   - 颜色：红色 (#F44336)
   - 功能：停止录音

##### 写入流程
1. 选择要写入的动作类型
2. 点击"写入 NFC 标签"按钮
3. 将空白 NFC 标签靠近手机背面
4. 等待写入完成
5. 震动反馈 + 提示"NFC 标签写入成功！"

##### 技术实现
- 支持 NDEF 格式标签
- 支持 NdefFormatable 标签（自动格式化）
- 写入 NDEF 消息包含：
  - URI 记录（heartecho 协议）
  - AAR 记录（应用包名）

#### B. 调试面板

##### 手动录音测试
- **功能**：不依赖 NFC 标签，直接触发录音
- **按钮**：绿色大按钮 "📝 手动录音测试"
- **用途**：
  - 测试录音功能
  - 验证权限
  - 调试音频质量

##### 播放列表
- **显示内容**：
  - 录音 ID
  - 时长（秒）
  - 创建时间
  - 播放状态（已播放/未播放）
- **操作**：
  - 播放按钮（蓝色）：播放该录音
  - 删除按钮（红色）：删除录音和文件

##### 列表特性
- 实时更新（Flow 监听数据库）
- 按创建时间倒序排列
- 空状态提示："暂无录音"

### UI 设计

#### 标签页
- **NFC 写入器**：标签写入功能
- **调试面板**：录音测试和列表管理

#### 配色方案
- 背景：深灰色 (#1E1E1E)
- 卡片：中灰色 (#2E2E2E)
- 按钮：深灰色 (#424242)
- 文字：白色

#### 返回按钮
- 位置：顶部左侧
- 文字："← 返回"
- 功能：退出管理员模式，返回空闲状态

### 权限要求

管理员模式需要以下权限：
- NFC 权限（读写）
- 录音权限（测试录音）
- 震动权限（反馈）

### 使用场景

#### 场景一：初次配置 NFC 标签
1. 长按首页左上角 5 秒进入管理员模式
2. 切换到"NFC 写入器"标签页
3. 选择"播放标签"
4. 点击"写入 NFC 标签"
5. 将空白标签靠近手机
6. 等待写入成功提示
7. 重复步骤 3-6 创建"录制标签"和"停止标签"

#### 场景二：测试录音功能
1. 进入管理员模式
2. 切换到"调试面板"标签页
3. 点击"手动录音测试"
4. 开始录音（30 秒倒计时）
5. 录音完成后进入确认界面
6. 点击"发送"保存录音
7. 在播放列表中查看新录音

#### 场景三：管理录音列表
1. 进入管理员模式 → 调试面板
2. 查看所有录音列表
3. 点击播放按钮试听录音
4. 点击删除按钮清理不需要的录音

### 技术实现

#### NFC 写入
```kotlin
// 创建 NDEF 消息
val message = nfcManager.createNdefMessage(action)

// 写入标签
ndef.connect()
ndef.writeNdefMessage(message)
ndef.close()
```

#### 支持的 NFC 技术
- `android.nfc.tech.Ndef` - 已格式化的 NDEF 标签
- `android.nfc.tech.NdefFormatable` - 可格式化的空白标签

#### Intent Filter
```xml
<!-- 支持所有 NFC 标签 -->
<intent-filter>
    <action android:name="android.nfc.action.TAG_DISCOVERED" />
</intent-filter>

<intent-filter>
    <action android:name="android.nfc.action.TECH_DISCOVERED" />
</intent-filter>
```

#### 状态管理
- `isWritingNfc`: 标记是否正在写入模式
- `nfcActionToWrite`: 待写入的动作类型
- 写入完成后自动重置状态

### 安全考虑

#### 隐藏入口
- 普通用户不易发现（轻微颜色差别）
- 需要长按 5 秒才能激活
- 防止误触

#### 权限控制
- 写入 NFC 需要 NFC 权限
- 录音测试需要录音权限
- 删除操作不可撤销（谨慎使用）

### 调试功能

#### 日志输出
- NFC 写入成功/失败
- 录音创建/删除
- 播放状态变化

#### 错误处理
- 标签不支持 NDEF 格式
- 写入失败（标签只读、容量不足）
- 文件删除失败

### 已实现的功能

✅ 隐形长按入口（5 秒激活）
✅ 环状长按进度圈
✅ NFC 写入器（三种标签类型）
✅ 支持空白标签自动格式化
✅ 手动录音测试
✅ 录音列表显示
✅ 播放录音功能
✅ 删除录音功能
✅ 实时数据库监听
✅ 震动反馈
✅ 返回按钮

### 测试清单

#### 入口测试
- [ ] 长按 5 秒激活管理员模式
- [ ] 进度圈动画正常
- [ ] 提前松手取消激活
- [ ] 图标透明度变化

#### NFC 写入测试
- [ ] 写入播放标签成功
- [ ] 写入录制标签成功
- [ ] 写入停止标签成功
- [ ] 空白标签自动格式化
- [ ] 写入成功震动反馈
- [ ] 写入失败错误提示

#### 调试面板测试
- [ ] 手动录音测试正常
- [ ] 录音列表显示正确
- [ ] 播放录音功能正常
- [ ] 删除录音功能正常
- [ ] 实时更新列表
- [ ] 空状态显示

#### 返回功能测试
- [ ] 返回按钮正常工作
- [ ] 退出后回到空闲状态
- [ ] NFC 写入状态正确重置

## 与普通模式的区别

| 功能 | 普通模式 | 管理员模式 |
|------|---------|-----------|
| NFC 读取 | ✅ | ✅ |
| NFC 写入 | ❌ | ✅ |
| 手动录音 | ❌ | ✅ |
| 录音列表 | ❌ | ✅ |
| 删除录音 | ❌ | ✅ |
| 播放测试 | ❌ | ✅ |
| 入口方式 | 默认 | 长按 5 秒 |

## 用户指南

### 给开发者/管理员
1. **首次配置**：使用 NFC 写入器创建三种标签
2. **功能测试**：使用调试面板测试录音和播放
3. **问题排查**：查看录音列表，播放测试录音
4. **清理数据**：删除测试录音

### 给普通用户
- 普通用户无需进入管理员模式
- 只需使用配置好的 NFC 标签
- 简单触碰即可完成所有操作

## 后续优化建议

### 功能增强
- [ ] 批量删除录音
- [ ] 导出录音文件
- [ ] 录音重命名
- [ ] 标签管理（查看已写入的标签）
- [ ] 统计信息（录音总数、总时长）

### 安全增强
- [ ] 密码保护管理员模式
- [ ] 操作日志记录
- [ ] 数据备份/恢复

### UI 优化
- [ ] 搜索和过滤录音
- [ ] 排序选项（时间、时长、状态）
- [ ] 批量操作选择模式
- [ ] 深色/浅色主题切换

---

**管理员模式状态**：✅ 已完整实现，可以进行 NFC 标签配置和调试测试
